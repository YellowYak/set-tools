{
  "rules": {
    // ── /games ────────────────────────────────────────────────────────────────
    // Anyone may read game state (real-time board sync requires it).
    // Anyone may write (guests are not Firebase Auth users, so identity
    // cannot be verified here — see NOTE below). Data-shape validation below
    // prevents the worst abuse: score roll-back, invalid status, junk fields.
    //
    // NOTE: To enforce per-player identity, migrate guests to Firebase
    // Anonymous Auth (signInAnonymously) and replace .write:true on
    // players/$playerId with:
    //   ".write": "$playerId === auth.uid || data.parent().parent().child('hostId').val() === auth.uid"
    "games": {
      ".read": true,
      "$gameId": {
        ".write": true,

        // Top-level shape: deletion is allowed (onDisconnect removes the node),
        // otherwise the required fields must all be present.
        ".validate": "!newData.exists() || newData.hasChildren(['status', 'hostId', 'maxPlayers', 'players', 'shuffledIndices', 'deckPointer', 'board'])",

        "status": {
          ".validate": "newData.isString() && (newData.val() === 'waiting' || newData.val() === 'playing' || newData.val() === 'finished')"
        },
        "isPrivate": {
          ".validate": "newData.isBoolean()"
        },
        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 4"
        },
        "hostId": {
          ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 64"
        },

        // Each entry in shuffledIndices must be a valid card index (0–80).
        "shuffledIndices": {
          "$idx": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 80"
          }
        },

        // deckPointer advances through the 81-card deck.
        "deckPointer": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 81"
        },

        // Each board slot holds a shuffledIndices value (0–80).
        "board": {
          "$pos": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 80"
          }
        },

        "players": {
          "$playerId": {
            ".validate": "newData.hasChildren(['name', 'score', 'connected'])",

            "name": {
              ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 24"
            },

            // Score may only increase — prevents a malicious client from
            // zeroing out or reducing another player's score.
            "score": {
              ".validate": "newData.isNumber() && newData.val() >= 0 && (!data.exists() || newData.val() >= data.val())"
            },

            "connected": {
              ".validate": "newData.isBoolean()"
            },

            // uid is the Firebase Auth uid stored alongside the guest id,
            // used when saving to Firestore. May be null for pure guests.
            "uid": {
              ".validate": "newData.val() === null || (newData.isString() && newData.val().length <= 128)"
            },

            // Reject any field not listed above.
            "$other": { ".validate": false }
          }
        },

        "startedAt":  { ".validate": "newData.val() === null || newData.isNumber()" },
        "finishedAt": { ".validate": "newData.val() === null || newData.isNumber()" },
        "winnerId":   { ".validate": "newData.val() === null || (newData.isString() && newData.val().length <= 64)" },

        // Reject any top-level field not listed above.
        "$other": { ".validate": false }
      }
    },

    // ── /lobbies ──────────────────────────────────────────────────────────────
    // Public game list. Same identity caveat as /games applies.
    "lobbies": {
      ".read": true,
      "$gameId": {
        ".write": true,

        // Deletion is allowed (lobby removed when game starts or host leaves).
        ".validate": "!newData.exists() || newData.hasChildren(['id', 'status', 'maxPlayers', 'playerCount', 'hostId', 'hostName', 'createdAt'])",

        "id":     { ".validate": "newData.isString() && newData.val().length >= 1" },
        "status": { ".validate": "newData.isString() && newData.val() === 'waiting'" },

        "maxPlayers": {
          ".validate": "newData.isNumber() && newData.val() >= 2 && newData.val() <= 4"
        },
        "playerCount": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 4"
        },
        "hostId":   { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 64" },
        "hostName": { ".validate": "newData.isString() && newData.val().length >= 1 && newData.val().length <= 24" },
        "createdAt": { ".validate": "newData.isNumber()" },

        "$other": { ".validate": false }
      }
    }
  }
}
